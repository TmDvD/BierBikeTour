<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Bierbike-Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { margin:0; font-family:sans-serif; background:#f4f4f4; display:flex; justify-content:center; align-items:center; min-height:100vh;}
#joinArea, #waitingArea, #quizArea { width:90%; max-width:500px; text-align:center;}
h1 { margin-bottom:20px;}
input, button { width:100%; padding:12px; font-size:1.1em; margin:8px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;}
.teamSelect { display:flex; justify-content:space-around; margin:15px 0;}
.teamBtn { flex:1; margin:0 5px; padding:15px; border-radius:10px; font-size:1.1em; cursor:pointer; border:none; color:white;}
.red { background:#d9534f; }
.blue { background:#0275d8; }
.inactive { opacity:0.4;}
.selected { border:3px solid #000; filter:brightness(1.2);}
#waitingArea img { max-width:200px; margin-top:40px;}
#questionHeader { background:#b2ebf2; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
#playerScore { font-size:1.2em; font-weight:bold; margin-bottom:10px; position:relative;}
#timer { font-size:1.5em; margin:10px 0; font-weight:bold;}
.answerBtn { width:100%; min-height:60px; margin:8px 0; font-size:1em; border-radius:8px; border:1px solid #aaa; cursor:pointer; background:#fff; transition:background 0.3s, transform 0.3s;}
.answerBtn.correct { background-color:#a2d5a2; }
.answerBtn.wrong { background-color:#f4a2a2; }
#countdownOverlay { position:fixed; top:0; left:0; width:100%; height:100%; color:white; display:flex; justify-content:center; align-items:center; font-size:3em; display:none; z-index:1000; transition: color 0.5s ease;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="joinArea">
  <img id="logo" src="Bilder/logo_lightmode.png" alt="Logo" style="max-width:150px;margin-bottom:20px;">
  <h1>Bierbike-Quiz</h1>
  <input id="playerName" type="text" placeholder="Dein Name (max 10 Zeichen)">
  <div class="teamSelect">
    <button id="redBtn" class="teamBtn red">Rotes Team</button>
    <button id="blueBtn" class="teamBtn blue">Blaues Team</button>
  </div>
  <button id="joinBtn">Beitreten</button>
</div>

<div id="waitingArea" style="display:none;">
  <img id="waitingLogo" src="Bilder/logo_lightmode.png" alt="Logo">
  <p id="waitingMessage">Bitte warten, der Admin startet das Spiel…</p>
</div>

<div id="quizArea" style="display:none;">
  <div id="playerScore">Punkte: 0</div>
  <div id="questionHeader">
    <div id="categoryName">Kategorie</div>
    <div id="questionPoints">1 Punkt</div>
  </div>
  <div id="timer">15</div>
  <div id="questionText">Frage erscheint hier…</div>
  <div id="answers"></div>
</div>

<div id="countdownOverlay">5</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDS2CTzFC_G-dTi-LE5umuvTWET4plsGH0",
  authDomain: "as-fensterbau-baf6c.firebaseapp.com",
  projectId: "as-fensterbau-baf6c",
  storageBucket: "as-fensterbau-baf6c.firebasestorage.app",
  messagingSenderId: "25696521871",
  appId: "1:25696521871:web:35cca5b0e39f88c4576afa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const playersCol = db.collection("players");
const gameState = db.collection("game").doc("state");

let selectedTeam = null;
let currentPlayerId = null;
let score = 0;
let currentQuestionIndex = 0;
let currentQuestionSet = 0;
let questionTimer;
const questionDuration = 15;

// Darkmode
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.getElementById("logo").src = "Bilder/logo_darkmode.png";
  document.getElementById("waitingLogo").src = "Bilder/logo_darkmode.png";
}

// Teamauswahl
document.getElementById("redBtn").addEventListener("click", ()=>selectTeam("rot"));
document.getElementById("blueBtn").addEventListener("click", ()=>selectTeam("blau"));
function selectTeam(team){
  selectedTeam=team;
  document.getElementById("redBtn").classList.remove("selected","inactive");
  document.getElementById("blueBtn").classList.remove("selected","inactive");
  if(team==="rot"){
    document.getElementById("redBtn").classList.add("selected");
    document.getElementById("blueBtn").classList.add("inactive");
  } else {
    document.getElementById("blueBtn").classList.add("selected");
    document.getElementById("redBtn").classList.add("inactive");
  }
}

// Fragen Daten
const questions=[{
  category:"Geografie",
  questions:[
    {text:"Welche Stadt ist die Hauptstadt von Frankreich?", answers:[{text:"Rom",correct:false},{text:"Berlin",correct:false},{text:"Paris",correct:true},{text:"Madrid",correct:false}]},
    {text:"Welches Land ist flächenmäßig das größte der Erde?", answers:[{text:"Kanada",correct:false},{text:"Russland",correct:true},{text:"USA",correct:false},{text:"China",correct:false}]},
    {text:"Welcher Fluss fließt durch Budapest?", answers:[{text:"Rhein",correct:false},{text:"Elbe",correct:false},{text:"Donau",correct:true},{text:"Po",correct:false}]},
    {text:"Welches Land hat keine Küste?", answers:[{text:"Bolivien",correct:true},{text:"Peru",correct:false},{text:"Kroatien",correct:false},{text:"Thailand",correct:false}]},
    {text:"In welchem Land liegt der höchste aktive Vulkan der Erde, der Ojos del Salado?", answers:[{text:"Chile",correct:true},{text:"Indonesien",correct:false},{text:"Italien",correct:false},{text:"Äthiopien",correct:false}]}
  ]
}];

// Spieler beitreten
document.getElementById("joinBtn").addEventListener("click",async()=>{
  const name=document.getElementById("playerName").value.trim();
  if(!name||name.length>10){ alert("Ungültiger Name (max 10 Zeichen)!"); return; }
  if(!selectedTeam){ alert("Bitte Team wählen!"); return; }

  const existing=await playersCol.where("name","==",name).get();
  if(!existing.empty){ alert("Name schon vergeben!"); return; }

  const gameDoc=await gameState.get();
  if(gameDoc.exists&&gameDoc.data().started){
    alert("Ein Spiel läuft gerade. Du kannst nicht beitreten!");
    return;
  }

  const docRef=await playersCol.add({name,team:selectedTeam,score:0});
  currentPlayerId=docRef.id;
  document.getElementById("joinArea").style.display="none";
  document.getElementById("waitingArea").style.display="block";
  document.getElementById("waitingMessage").textContent="Das Spiel wird gleich durch den Admin gestartet…";
});

// GameState Listener
gameState.onSnapshot(doc=>{
  const data=doc.data();
  if(!data) return;

  if(data.gameReset){
    document.getElementById("quizArea").style.display="none";
    document.getElementById("waitingArea").style.display="none";
    document.getElementById("joinArea").style.display="block";
    document.getElementById("playerName").value="";
    selectedTeam=null;
    if(currentPlayerId){ playersCol.doc(currentPlayerId).delete(); currentPlayerId=null; }
    gameState.update({gameReset:false});
  }

  if(data.started && currentPlayerId){
    startCountdown(5);
  }
});

// Countdown Overlay
function startCountdown(sec){
  const overlay=document.getElementById("countdownOverlay");
  overlay.style.display="flex";
  let c=sec;
  overlay.textContent=c;
  const colors=["#28a745","#8bc34a","#ffc107","#ff9800","#dc3545"];
  let idx=0;
  overlay.style.color=colors[idx];

  const int=setInterval(()=>{
    c--; idx++;
    if(idx<colors.length) overlay.style.color=colors[idx];
    overlay.textContent=c>0?c:"Start!";
    if(c<0){
      clearInterval(int);
      overlay.style.display="none";
      document.getElementById("waitingArea").style.display="none";
      document.getElementById("quizArea").style.display="block";
      showQuestion();
    }
  },1000);
}

// Frage anzeigen
function showQuestion(){
  clearInterval(questionTimer);
  const qSet=questions[currentQuestionSet];
  const q=qSet.questions[currentQuestionIndex];
  document.getElementById("categoryName").textContent=qSet.category;
  document.getElementById("questionText").textContent=q.text;
  document.getElementById("questionPoints").textContent=(currentQuestionIndex+1)+" Punkt(e)";
  const answersDiv=document.getElementById("answers");
  answersDiv.innerHTML="";

  let timeLeft=questionDuration;
  const timerEl=document.getElementById("timer");
  timerEl.textContent=timeLeft;
  questionTimer=setInterval(()=>{
    timeLeft--;
    timerEl.textContent=timeLeft;
    if(timeLeft<=0){ clearInterval(questionTimer); autoNextQuestion(); }
  },1000);

  q.answers.forEach(a=>{
    const btn=document.createElement("button");
    btn.textContent=a.text;
    btn.className="answerBtn";
    btn.dataset.correct=a.correct;
    btn.onclick=()=>selectAnswer(btn,a.correct);
    answersDiv.appendChild(btn);
  });
}

function selectAnswer(btn,correct){
  clearInterval(questionTimer);
  const buttons=document.querySelectorAll(".answerBtn");
  buttons.forEach(b=>{ b.disabled=true; if(b.dataset.correct==="true") b.classList.add("correct"); });
  const points=currentQuestionIndex+1;
  if(correct){ btn.classList.add("correct"); score+=points; document.getElementById("playerScore").textContent="Punkte: "+score; animateScore(points);}
  else btn.classList.add("wrong");
  setTimeout(autoNextQuestion,1000);
}

function autoNextQuestion(){
  currentQuestionIndex++;
  const qSet=questions[currentQuestionSet];
  if(currentQuestionIndex>=qSet.questions.length){
    currentQuestionIndex=0;
    alert("Kategorie abgeschlossen!");
  } else showQuestion();
}

function animateScore(points){
  const scoreEl=document.getElementById("playerScore");
  scoreEl.style.transform="scale(1.3)";
  setTimeout(()=>scoreEl.style.transform="scale(1)",300);
  const plus=document.createElement("span");
  plus.textContent="+"+points;
  plus.style.position="absolute";
  plus.style.color="#28a745";
  plus.style.fontWeight="bold";
  plus.style.fontSize="1.2em";
  plus.style.top="-10px";
  plus.style.right="-20px";
  document.body.appendChild(plus);
  setTimeout(()=>plus.remove(),800);
}
</script>
</body>
</html>
