<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Bierbike Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: sans-serif;
      display: flex; justify-content: center; align-items: center;
      background: #fafafa;
    }
    #joinArea, #quizArea {
      width: 95%; max-width: 600px;
      display: none; flex-direction: column; align-items: center;
    }
    #joinArea { display: flex; }
    h1 { text-align: center; }
    input, button {
      width: 100%; padding: 12px; margin: 5px 0;
      font-size: 1.2em; border-radius: 8px; box-sizing: border-box;
    }
    .teamSelect { display: flex; justify-content: space-around; width: 100%; margin: 10px 0; }
    .teamOption {
      flex: 1; margin: 0 5px; padding: 15px; text-align: center;
      border-radius: 8px; font-weight: bold; cursor: pointer;
    }
    .selected { border: 3px solid #000; filter: brightness(1.2); }
    .disabled { opacity: 0.4; pointer-events: none; }
    #quizArea { text-align: center; }
    #playerScore {
      font-size: 1.8em; font-weight: bold;
      margin-bottom: 10px;
    }
    .categoryBar {
      width: 100%; padding: 8px;
      display: flex; justify-content: space-between;
      align-items: center; color: white; font-weight: bold;
      border-radius: 6px; margin-bottom: 5px;
    }
    #questionTimer { font-size: 1.5em; margin: 5px 0; }
    #questionText { font-size: 1.2em; margin: 10px 0; }
    .option {
      padding: 10px; margin: 5px 0;
      background: #eee; border-radius: 6px;
      cursor: pointer; font-size: 1.1em;
    }
    #endMessage {
      font-size: 1.8em; font-weight: bold; margin-top: 20px;
    }
    #logo { max-width: 200px; margin-bottom: 20px; }
    #countdownOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background:#333; color:white;
      display:flex; justify-content:center; align-items:center;
      font-size:3em; display:none;
      z-index:1000;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="joinArea">
  <img id="logo" src="Bilder/logo_lightmode.png" alt="Logo">
  <h1>Bierbike Quiz</h1>
  <input type="text" id="playerName" placeholder="Dein Name (max. 10 Zeichen)">
  <div class="teamSelect">
    <div id="teamRed" class="teamOption" style="background:#e74c3c;">Rot</div>
    <div id="teamBlue" class="teamOption" style="background:#3498db;">Blau</div>
  </div>
  <button id="joinBtn">Mitspielen</button>
</div>

<div id="quizArea">
  <div id="playerScore">Punkte: 0</div>
  <div id="categoryBar" class="categoryBar"></div>
  <div id="questionTimer"></div>
  <div id="questionText"></div>
  <div id="options"></div>
  <div id="endMessage"></div>
</div>

<div id="countdownOverlay">15</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDS2CTzFC_G-dTi-LE5umuvTWET4plsGH0",
  authDomain: "as-fensterbau-baf6c.firebaseapp.com",
  projectId: "as-fensterbau-baf6c",
  storageBucket: "as-fensterbau-baf6c.firebasestorage.app",
  messagingSenderId: "25696521871",
  appId: "1:25696521871:web:35cca5b0e39f88c4576afa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const playersCol = db.collection('players');
const gameState = db.collection('game').doc('state');

let playerRef=null, playerData={}, selectedTeam=null;
let currentQIndex=0, questionTimer, countdownTimer;

// Dark/Light Logo
function updateLogo(){
  const logo=document.getElementById('logo');
  if(window.matchMedia('(prefers-color-scheme: dark)').matches){
    logo.src='Bilder/logo_darkmode.png';
  } else {
    logo.src='Bilder/logo_lightmode.png';
  }
}
window.addEventListener('load', updateLogo);
if(window.matchMedia){
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateLogo);
}

// Team Auswahl
document.getElementById('teamRed').addEventListener('click', ()=>{
  selectedTeam='rot';
  document.getElementById('teamRed').classList.add('selected');
  document.getElementById('teamBlue').classList.add('disabled');
});
document.getElementById('teamBlue').addEventListener('click', ()=>{
  selectedTeam='blau';
  document.getElementById('teamBlue').classList.add('selected');
  document.getElementById('teamRed').classList.add('disabled');
});

// Join
document.getElementById('joinBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('playerName').value.trim();
  if(name.length===0 || name.length>10){alert("Name ung√ºltig");return;}
  const exists=await playersCol.where('name','==',name).get();
  if(!exists.empty){alert("Name schon vergeben");return;}
  if(!selectedTeam){alert("Team w√§hlen!");return;}
  playerData={name, team:selectedTeam, score:0};
  playerRef=await playersCol.add(playerData);
  document.getElementById('joinArea').style.display='none';
  document.getElementById('quizArea').style.display='flex';
});

// Reset √úberwachung
gameState.onSnapshot(doc=>{
  const data=doc.data();
  if(data?.gameReset){
    document.getElementById('quizArea').style.display='none';
    document.getElementById('joinArea').style.display='flex';
    document.getElementById('playerName').value='';
    selectedTeam=null;
    document.getElementById('teamRed').classList.remove('selected','disabled');
    document.getElementById('teamBlue').classList.remove('selected','disabled');
    gameState.update({gameReset:false});
  }
});

// Start √úberwachung
gameState.onSnapshot(doc=>{
  const data=doc.data();
  if(data?.started && data.currentQuestionIndex===0){
    startCountdown();
  }
});

// Start-Countdown mit wechselnden Farben
function startCountdown(){
  const overlay=document.getElementById('countdownOverlay');
  overlay.style.display='flex';
  let time=15;
  const colors=['#e74c3c','#3498db','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22'];
  countdownTimer=setInterval(()=>{
    overlay.textContent=time;
    overlay.style.background=colors[time % colors.length];
    time--;
    if(time<0){
      clearInterval(countdownTimer);
      overlay.style.display='none';
      showQuestion(0);
    }
  },1000);
}

// Fragen Demo
const questions=[
  {cat:'Allgemein',points:1,question:'Frage 1?',options:['A','B','C','D'],answer:0},
  {cat:'Allgemein',points:2,question:'Frage 2?',options:['A','B','C','D'],answer:1},
  {cat:'Sport',points:1,question:'Sport 1?',options:['A','B','C','D'],answer:2}
];

function showQuestion(index){
  if(index>=questions.length){
    document.getElementById('questionText').textContent='';
    document.getElementById('options').innerHTML='';
    document.getElementById('categoryBar').textContent='';
    document.getElementById('endMessage').textContent="Feierabend, ihr Legenden! üç∫";
    return;
  }
  const q=questions[index];
  document.getElementById('playerScore').textContent=`Punkte: ${playerData.score}`;
  document.getElementById('categoryBar').innerHTML=
    `<span>${q.cat}</span><span>${q.points} ${q.points===1?'Punkt':'Punkte'}</span>`;
  document.getElementById('questionText').textContent=q.question;
  const optDiv=document.getElementById('options'); optDiv.innerHTML='';
  q.options.forEach((opt,i)=>{
    const div=document.createElement('div');
    div.className='option'; div.textContent=opt;
    div.addEventListener('click',()=>{
      if(i===q.answer) playerData.score+=q.points;
      document.getElementById('playerScore').textContent=`Punkte: ${playerData.score}`;
      clearInterval(questionTimer);
      setTimeout(()=>{showQuestion(index+1)},2000);
    });
    optDiv.appendChild(div);
  });
  // Timer
  let t=15;
  document.getElementById('questionTimer').textContent=t;
  questionTimer=setInterval(()=>{
    t--; document.getElementById('questionTimer').textContent=t;
    if(t<=0){
      clearInterval(questionTimer);
      setTimeout(()=>{showQuestion(index+1)},2000);
    }
  },1000);
}
</script>
</body>
</html>
