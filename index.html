<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Bierbike-Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { margin:0; font-family:sans-serif; background:#f4f4f4; display:flex; justify-content:center; align-items:center; min-height:100vh; position:relative;}
#joinArea, #waitingArea, #quizArea { width:90%; max-width:500px; text-align:center;}
h1 { margin-bottom:20px;}
input, button { width:100%; padding:12px; font-size:1.1em; margin:8px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;}
.teamSelect { display:flex; justify-content:space-around; margin:15px 0;}
.teamBtn { flex:1; margin:0 5px; padding:15px; border-radius:10px; font-size:1.1em; cursor:pointer; border:none; color:white;}
.red { background:#d9534f; }
.blue { background:#0275d8; }
.inactive { opacity:0.4;}
.selected { border:3px solid #000; filter:brightness(1.2);}
#waitingArea img { max-width:200px; margin-top:40px;}
#questionHeader { background:#b2ebf2; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
#playerScore { font-size:1.2em; font-weight:bold; margin-bottom:10px; position:relative;}
#timer { font-size:1.5em; margin:10px 0; font-weight:bold;}
.answerBtn { width:100%; min-height:60px; margin:8px 0; font-size:1em; border-radius:8px; border:1px solid #aaa; cursor:pointer; background:#fff; transition:background 0.3s, transform 0.3s;}
.answerBtn.correct { background-color:#a2d5a2; }
.answerBtn.wrong { background-color:#f4a2a2; }
#countdownOverlay { position:fixed; top:20%; left:0; width:100%; height:60px; color:white; display:flex; justify-content:center; align-items:center; font-size:3em; display:none; z-index:1000; transition: color 0.5s ease;}
#progress { position:fixed; bottom:10px; width:100%; text-align:center; font-weight:bold; font-size:1.1em; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<div id="joinArea">
  <img id="logo" src="Bilder/logo_lightmode.png" alt="Logo" style="max-width:150px;margin-bottom:20px;">
  <h1>Bierbike-Quiz</h1>
  <input id="playerName" type="text" placeholder="Dein Name (max 10 Zeichen)">
  <div class="teamSelect">
    <button id="redBtn" class="teamBtn red">Rotes Team</button>
    <button id="blueBtn" class="teamBtn blue">Blaues Team</button>
  </div>
  <button id="joinBtn">Beitreten</button>
</div>

<div id="waitingArea" style="display:none;">
  <img id="waitingLogo" src="Bilder/logo_lightmode.png" alt="Logo">
  <p id="waitingMessage">Bitte warten, der Admin startet das Spiel…</p>
</div>

<div id="quizArea" style="display:none;">
  <div id="playerScore">Punkte: 0</div>
  <div id="questionHeader">
    <div id="categoryName">Kategorie</div>
    <div id="questionPoints">1 Punkt</div>
  </div>
  <div id="timer">15</div>
  <div id="questionText">Frage erscheint hier…</div>
  <div id="answers"></div>
</div>

<div id="countdownOverlay">5</div>
<div id="progress"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDS2CTzFC_G-dTi-LE5umuvTWET4plsGH0",
  authDomain: "as-fensterbau-baf6c.firebaseapp.com",
  projectId: "as-fensterbau-baf6c",
  storageBucket: "as-fensterbau-baf6c.firebasestorage.app",
  messagingSenderId: "25696521871",
  appId: "1:25696521871:web:35cca5b0e39f88c4576afa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const playersCol = db.collection("players");
const gameState = db.collection("game").doc("state");

let selectedTeam = null;
let currentPlayerId = null;
let score = 0;
let currentQuestionSet = 0;
let currentQuestionIndex = 0;
let questionTimer;
const questionDuration = 15;

// Darkmode
if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
  document.getElementById("logo").src="Bilder/logo_darkmode.png";
  document.getElementById("waitingLogo").src="Bilder/logo_darkmode.png";
}

// Team-Auswahl
document.getElementById("redBtn").addEventListener("click", ()=>selectTeam("rot"));
document.getElementById("blueBtn").addEventListener("click", ()=>selectTeam("blau"));
function selectTeam(team){
  selectedTeam=team;
  document.getElementById("redBtn").classList.remove("selected","inactive");
  document.getElementById("blueBtn").classList.remove("selected","inactive");
  if(team==="rot"){
    document.getElementById("redBtn").classList.add("selected");
    document.getElementById("blueBtn").classList.add("inactive");
  } else {
    document.getElementById("blueBtn").classList.add("selected");
    document.getElementById("redBtn").classList.add("inactive");
  }
}

// Fragen und Kategorien
let questionCategories=[
  {
    category:"Geografie",
    questions:[
      {text:"Welche Stadt ist die Hauptstadt von Frankreich?", answers:[{text:"Rom",correct:false},{text:"Berlin",correct:false},{text:"Paris",correct:true},{text:"Madrid",correct:false}]},
      {text:"Welches Land ist flächenmäßig das größte der Erde?", answers:[{text:"Kanada",correct:false},{text:"Russland",correct:true},{text:"USA",correct:false},{text:"China",correct:false}]},
      {text:"Welcher Fluss fließt durch Budapest?", answers:[{text:"Rhein",correct:false},{text:"Elbe",correct:false},{text:"Donau",correct:true},{text:"Po",correct:false}]},
      {text:"Welches Land hat keine Küste?", answers:[{text:"Bolivien",correct:true},{text:"Peru",correct:false},{text:"Kroatien",correct:false},{text:"Thailand",correct:false}]},
      {text:"In welchem Land liegt der höchste aktive Vulkan der Erde, der Ojos del Salado?", answers:[{text:"Chile",correct:true},{text:"Indonesien",correct:false},{text:"Italien",correct:false},{text:"Äthiopien",correct:false}]}
    ]
  },
  {
    category:"Geschichte",
    questions:[
      {text:"Wer war der erste Bundeskanzler der BRD?", answers:[{text:"Willy Brandt",correct:false},{text:"Gerhard Schröder",correct:false},{text:"Konrad Adenauer",correct:true},{text:"Helmut Kohl",correct:false}]},
      {text:"In welchem Jahr fiel die Berliner Mauer?", answers:[{text:"1981",correct:false},{text:"1985",correct:false},{text:"1989",correct:true},{text:"1991",correct:false}]},
      {text:"Wer führte den Zug über die Alpen mit Elefanten?", answers:[{text:"Caesar",correct:false},{text:"Alexander der Große",correct:false},{text:"Hannibal",correct:true},{text:"Napoleon",correct:false}]},
      {text:"Welcher Krieg endete mit dem Westfälischen Frieden 1648?", answers:[{text:"Erster Weltkrieg",correct:false},{text:"Dreißigjähriger Krieg",correct:true},{text:"Hundertjähriger Krieg",correct:false},{text:"Spanischer Erbfolgekrieg",correct:false}]},
      {text:"Welches Jahr markiert den Beginn der Französischen Revolution?", answers:[{text:"1776",correct:false},{text:"1804",correct:false},{text:"1789",correct:true},{text:"1812",correct:false}]}
    ]
  }
];
questionCategories = questionCategories.sort(()=>Math.random()-0.5);

// Spieler beitreten
document.getElementById("joinBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("playerName").value.trim();
  if(!name||name.length>10){ alert("Ungültiger Name (max 10 Zeichen)!"); return; }
  if(!selectedTeam){ alert("Bitte Team wählen!"); return; }

  const existing=await playersCol.where("name","==",name).get();
  if(!existing.empty){ alert("Name schon vergeben!"); return; }

  const gameDoc=await gameState.get();
  if(gameDoc.exists && gameDoc.data().started){ alert("Ein Spiel läuft gerade. Du kannst nicht beitreten!"); return; }

  const docRef=await playersCol.add({name,team:selectedTeam,score:0});
  currentPlayerId=docRef.id;
  document.getElementById("joinArea").style.display="none";
  document.getElementById("waitingArea").style.display="block";
  document.getElementById("waitingMessage").textContent="Das Spiel wird gleich durch den Admin gestartet…";
});

// GameState Listener
gameState.onSnapshot(doc=>{
  const data=doc.data();
  if(!data) return;
  if(data.started && currentPlayerId){ startCountdown(5); }
  if(data.gameReset){
    document.getElementById("quizArea").style.display="none";
    document.getElementById("waitingArea").style.display="none";
    document.getElementById("joinArea").style.display="block";
    document.getElementById("playerName").value="";
    selectedTeam=null;
    score=0; currentQuestionIndex=0; currentQuestionSet=0;
    if(currentPlayerId){ playersCol.doc(currentPlayerId).delete(); currentPlayerId=null; }
    gameState.update({gameReset:false});
  }
});

// Countdown Overlay
function startCountdown(sec){
  const overlay=document.getElementById("countdownOverlay");
  overlay.style.display="flex";
  let c=sec;
  overlay.textContent=c;
  const colors=["#28a745","#8bc34a","#ffc107","#ff9800","#dc3545"];
  let idx=0;
  overlay.style.color=colors[idx];
  const int=setInterval(()=>{
    c--; idx++;
    if(idx<colors.length) overlay.style.color=colors[idx];
    overlay.textContent=c>0?c:"Start!";
    if(c<0){ clearInterval(int); overlay.style.display="none"; document.getElementById("waitingArea").style.display="none"; document.getElementById("quizArea").style.display="block"; showQuestion(); }
  },1000);
}

// Frage anzeigen
function showQuestion(){
  clearInterval(questionTimer);
  const qSet=questionCategories[currentQuestionSet];
  const q=qSet.questions[currentQuestionIndex];

  const categoryEl=document.getElementById("categoryName");
  categoryEl.textContent=qSet.category;

  if(currentQuestionIndex===0) animateCategory(categoryEl,currentQuestionSet);

  document.getElementById("questionText").textContent=q.text;

  const currentPoints = currentQuestionIndex+1;
  document.getElementById("questionPoints").textContent=currentPoints+" Punkt"+(currentPoints>1?"e":"");

  // Fortschritt unten
  document.getElementById("progress").textContent = (currentQuestionIndex+1) + " von " + qSet.questions.length;

  const answersDiv=document.getElementById("answers");
  answersDiv.innerHTML="";

  let timeLeft=questionDuration;
  const timerEl=document.getElementById("timer");
  timerEl.textContent=timeLeft;
  questionTimer=setInterval(()=>{
    timeLeft--;
    timerEl.textContent=timeLeft;
    if(timeLeft<=0){ clearInterval(questionTimer); autoNextQuestion(); }
  },1000);

  q.answers.forEach(a=>{
    const btn=document.createElement("button");
    btn.textContent=a.text;
    btn.className="answerBtn";
    btn.dataset.correct=a.correct;
    btn.onclick=()=>selectAnswer(btn,a.correct,currentPoints);
    answersDiv.appendChild(btn);
  });
}

// Kategorie animieren (mittig) 3 Sekunden
function animateCategory(categoryEl,categoryIndex){
  const colors=["#03a9f4","#ff9800","#8bc34a","#e91e63","#9c27b0"];
  const color=colors[categoryIndex % colors.length];

  // Balkenfarbe unter Header
  const questionHeader=document.getElementById("questionHeader");
  questionHeader.style.background=color;

  const overlay=document.createElement("div");
  overlay.textContent=categoryEl.textContent;
  overlay.style.position="fixed";
  overlay.style.top="50%";
  overlay.style.left="50%";
  overlay.style.transform="translate(-50%,-50%) scale(1.5)";
  overlay.style.padding="20px 40px";
  overlay.style.background=color;
  overlay.style.color="#fff";
  overlay.style.fontSize="2em";
  overlay.style.fontWeight="bold";
  overlay.style.borderRadius="8px";
  overlay.style.zIndex="2000";
  overlay.style.boxShadow="0 0 20px rgba(0,0,0,0.5)";
  overlay.style.textAlign="center";
  overlay.style.transition="transform 0.3s";

  document.body.appendChild(overlay);

  setTimeout(()=>{
    overlay.style.transform="translate(-50%,-50%) scale(1)";
    setTimeout(()=>{
      overlay.remove();
      categoryEl.style.border="none";
    },3000);
  },10);
}

// Antworten und Punkteanimation
function selectAnswer(btn,correct,currentPoints){
  clearInterval(questionTimer);
  const buttons=document.querySelectorAll(".answerBtn");
  buttons.forEach(b=>{
    b.disabled=true;
    if(b.dataset.correct==="true") b.classList.add("correct");
  });
  if(correct){
    btn.classList.add("correct");
    score+=currentPoints;
    animateScore(currentPoints);
  } else btn.classList.add("wrong");
  setTimeout(autoNextQuestion,1000);
}

function autoNextQuestion(){
  currentQuestionIndex++;
  const qSet=questionCategories[currentQuestionSet];
  if(currentQuestionIndex>=qSet.questions.length){
    currentQuestionIndex=0;
    currentQuestionSet++;
    if(currentQuestionSet>=questionCategories.length){
      alert("Quiz beendet!");
      return;
    }
  }
  showQuestion();
}

// Gesamtpunkteanimation
function animateScore(points){
  const scoreEl=document.getElementById("playerScore");
  scoreEl.textContent="Punkte: "+score;
  scoreEl.style.transition="transform 0.3s";
  scoreEl.style.transform="scale(1.3)";
  setTimeout(()=>scoreEl.style.transform="scale(1)",300);

  const plus=document.createElement("span");
  plus.textContent="+"+points;
  plus.style.position="absolute";
  plus.style.color="#28a745";
  plus.style.fontWeight="bold";
  plus.style.fontSize="1.2em";
  plus.style.top="-10px";
  plus.style.right="-20px";
  document.body.appendChild(plus);
  setTimeout(()=>plus.remove(),800);
}
</script>
</body>
</html>
